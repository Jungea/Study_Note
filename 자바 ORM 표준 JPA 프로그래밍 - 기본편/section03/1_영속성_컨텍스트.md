# 영속성 컨텍스트
- EntityManagerFactory가 요청이 올 때 EntityManager를 생성

## 영속성 컨텍스트
- 엔티티를 영구 저장하는 환경 (논리적)
- `EntityManager.persist(entity);`
	- 엔티티를 영속성 컨텍스트에 저장
- EntityManager를 통해서 영속성 컨텍스트에 접근
- EntityManager와 영속성 컨텍스트는 1:1

## 엔티티의 생명주기
- 비영속
	- 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태
- 영속
	- 영속성 컨텍스트에 관리되는 상태
	- `em.persist(member);`
```java
//비영속  
Member member = new Member();  
member.setId(101L);  
member.setName("HelloJPA");  
  
//영속  
em.persist(member);
```

- 준영속
	- 영속성 컨텍스트에 저장되었다가 분리된 상태
	- `em.detach(member);`
- 삭제
	- 삭제된 상태
	- `em.remove(member);`

## 영속성 컨텍스트의 이점
- 1차 캐시
	- 1차 캐시에서 먼저 확인 후 DB 조회
	- DB 조회 후 1차 캐시에 저장
	- 한 트랜잭션 안에서만 작동
	- (ID, ENTITY)
```java
Member member = new Member();  
member.setId(101L);  
member.setName("HelloJPA");  
  
em.persist(member);  
  
Member findMember = em.find(Member.class, 101L); //select 쿼리 없음
System.out.println("findMember.getId() = " + findMember.getId());  
System.out.println("findMember.getName() = " + findMember.getName());  
  
tx.commit();
```

```text
findMember.getId() = 101
findMember.getName() = HelloJPA
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (name, id) 
        values
            (?, ?)
```
- 영속 엔티티의 동일성 보장
```java

Member findMember1 = em.find(Member.class, 101L);  
Member findMember2 = em.find(Member.class, 101L);  //select 쿼리 없음
  
System.out.println("result = " + (findMember1 == findMember2));  //true
```

```text
Hibernate: 
    select
        member0_.id as id1_0_0_,
        member0_.name as name2_0_0_ 
    from
        Member member0_ 
    where
        member0_.id=?
findMember1 == findMember2 : true
```

- 트랜잭션을 지원하는 쓰기 지연
	- persist 할 경우 INSERT SQL 문장이 **쓰기 지연 SQL 저장소**에 저장
	- transaction.commit() -> 저장된 INSERT SQL flush
```java
Member member1 = new Member(150L, "A");  
Member member2 = new Member(160L, "B");  
  
em.persist(member1);  
em.persist(member2);  
  
System.out.println("======================");
tx.commit();  //insert
```

```text
======================
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (name, id) 
        values
            (?, ?)
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (name, id) 
        values
            (?, ?)
```
- 변경 감지(Dirty Che)